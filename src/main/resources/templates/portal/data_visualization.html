<th:block th:if="${!#lists.isEmpty(@websiteData.postYearlyStatsList)}">
    <div id="donut-chart" style="height: 300px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <div id="radar-chart" style="height: 300px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <div id="post-chart" style="height: 300px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <div id="trend-chart" style="height: 300px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <script th:inline="javascript">
        function getAxisBreakRange(data) {
            const validData = data.filter(val => typeof val === 'number' && !isNaN(val)).sort((a, b) => a - b);
            if (validData.length <= 4) return { hasOutlier: false };

            const q1Index = Math.floor(validData.length * 0.25);
            const q3Index = Math.ceil(validData.length * 0.75) - 1;
            const Q1 = validData[q1Index];
            const Q3 = validData[q3Index];
            const IQR = Q3 - Q1;

            const outlierThreshold = Q3 + 1.5 * IQR;
            const outliers = validData.filter(val => val > outlierThreshold);
            if (outliers.length === 0) return { hasOutlier: false };

            const normalMax = Math.max(...validData.filter(val => val <= outlierThreshold));
            const outlierMax = Math.max(...outliers);
            return {
                hasOutlier: true,
                start: normalMax,
                end: outlierMax,
                gap: "1.5%"
            };
        }
        document.addEventListener('DOMContentLoaded', ev => {
            const loadECharts = () => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.referrerPolicy = 'no-referrer';
                    script.crossOrigin = 'anonymous';
                    script.src = /*[[${@portal.js.get('echarts').getFirst()}]]*/ 'http://echarts.js';
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('ECharts loads on error'))
                    document.body.appendChild(script);
                });
            };
            loadECharts()
                .then(() => {
                    if (typeof echarts !== 'undefined') {
                        const yearlyStats = /*[[${@websiteData.postYearlyStatsList}]]*/ [];
                        const totalPosts = yearlyStats.reduce((acc, curr) => acc + curr.count, 0);
                        const graphicTitle = /*[[#{data_posts_count}]]*/ "";

                        const legend = {
                            type: 'scroll',
                            orient: 'vertical',
                            icon: 'circle',
                            right: 0,
                            top: 'center',
                            itemWidth: 10,
                            itemHeight: 10,
                        };
                        try {
                            const donutChartDom = document.getElementById('donut-chart');
                            var donutChart = echarts.init(donutChartDom);
                            const option = {
                                graphic: {
                                    elements: [
                                        {
                                            type: 'text',
                                            left: 'center',
                                            top: 'center',
                                            style: {
                                                text: `${graphicTitle}\n\n${totalPosts}`,
                                                textAlign: 'center',
                                                fontSize: 30,
                                                fontWeight: 'bolder',
                                                lineDash: [0, 200],
                                                lineDashOffset: 0,
                                                fill: '#FFE50B',
                                                stroke: 'rgb(0,0,0,0.7)',
                                                lineWidth: 1,
                                            },
                                            onclick: () => {
                                                window.location.href = "/";
                                            },
                                            keyframeAnimation: {
                                                duration: 3000,
                                                loop: false,
                                                keyframes: [
                                                    {
                                                        percent: 0.7,
                                                        style: {
                                                            fill: '#FC0006',
                                                            lineDashOffset: 200,
                                                            lineDash: [200, 0]
                                                        }
                                                    },
                                                    {
                                                        // Stop for a while.
                                                        percent: 0.8,
                                                        style: {
                                                            fill: 'transparent'
                                                        }
                                                    },
                                                    {
                                                        percent: 1,
                                                        style: {
                                                            fill: '#4CAF50'
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ],
                                },
                                tooltip: {
                                    valueFormatter: (value) => {
                                        return `${value}/${totalPosts} (${(value*100/totalPosts).toFixed(0)}%)`
                                    }
                                },
                                legend: legend,
                                series: [{
                                    type: 'pie',
                                    radius: ['55%', '75%'],
                                    label: {
                                        show: false,
                                    },
                                    data: yearlyStats.map(item=>({
                                        value: item.count,
                                        name: item.year,
                                    })),
                                }],
                            }
                            donutChart.setOption(option);
                        } catch (e) {
                        }

                        const monthlyStats = /*[[${@websiteData.postMonthlyStatsList}]]*/ [];
                        const monthNamesStr = /*[[#{data_months}]]*/ "";
                        const monthNames = monthNamesStr.split(",");
                        const yearGroup = {};
                        const yearLegend = {};
                        monthlyStats.forEach(item => {
                            const year = item.year;
                            if (!yearGroup[year]) {
                                yearGroup[year] = {};
                            }
                            yearGroup[year][item.month] = item.count;
                            if (!yearLegend[year]) {
                                yearLegend[year] = false;
                            }
                        })
                        const chartData = [];
                        Object.keys(yearGroup).forEach(year => {
                            const monthData = [];
                            for (let i = 1; i <= 12; i++) {
                                monthData.push(yearGroup[year][i] || 0);
                            }
                            chartData.push({
                                year: year,
                                data: monthData,
                            })
                        });

                        let selectedLegend = {};
                        if (Object.keys(yearLegend).length > 3) {
                            Object.keys(yearLegend)
                                .sort(() => 0.5 - Math.random())
                                .slice(0, 3)
                                .forEach(k => yearLegend[k] = true);
                            selectedLegend = yearLegend;
                        }
                        try {
                            const radarChartDom = document.getElementById('radar-chart');
                            var radarChart = echarts.init(radarChartDom);
                            const option = {
                                legend: {
                                    ...legend,
                                    selected: selectedLegend,
                                },
                                tooltip: {},
                                radar: [{
                                    indicator: monthNames.map(item => ({
                                        name: item,
                                    })),
                                    radius: '60%',
                                    axisNameGap: 10,
                                }],
                                series: [{
                                    type: 'radar',
                                    areaStyle: {},
                                    data: chartData.map(item => ({
                                        name: item.year,
                                        value: item.data,
                                    })),
                                    emphasis: {
                                        focus: 'self',
                                    },
                                }],
                            };
                            radarChart.setOption(option);
                        } catch (e) {
                        }

                        try {
                            const postChartDom = document.getElementById('post-chart');
                            var postChart = echarts.init(postChartDom);
                            const years = [...new Set(monthlyStats.map(item => item.year))]
                            const series = monthNames.map((monthName, monthIndex) => {
                                const values = years.map(year => {
                                    const matchItem = monthlyStats.find(item => item.year === year && item.month === (monthIndex + 1));
                                    return matchItem ? matchItem.count : 0;
                                });
                                return {
                                    name: monthName,
                                    type: 'bar',
                                    stack: 'total',
                                    data: values,
                                    emphasis: {
                                        focus: 'series',
                                    },
                                }
                            })

                            if (yearlyStats?.length > 0) {
                                series.unshift({
                                    name: /*[[#{data_yearly_posts}]]*/ "历年文章数",
                                    color: '#4CAF50',
                                    data: yearlyStats.map(item => item.count),
                                    type: 'line',
                                    smooth: true,
                                    label: {
                                        show: true,
                                    },
                                });
                            }
                            const option = {
                                title: {
                                    text: /*[[#{data_yearly_posts}]]*/ "历年文章数"
                                },
                                legend: {
                                    type: 'scroll',
                                    left: '5%',
                                },
                                tooltip: {
                                    axisPointer: {
                                        type: 'cross',
                                        crossStyle: {
                                            color: '#999',
                                        }
                                    }
                                },
                                grid: {
                                    show: false,
                                    left: '5%',
                                    right: '5%',
                                    bottom: '15%',
                                    containLabel: true,
                                },
                                xAxis: {
                                    type: 'category',
                                    data: years,
                                },
                                yAxis: {
                                    type: 'value'
                                },
                                series: series
                            };
                            postChart.setOption(option);
                        } catch (e) {
                        }

                        try {
                            const trendChartDom = document.getElementById('trend-chart');
                            var trendChart = echarts.init(trendChartDom);
                            const breakConfig = getAxisBreakRange(monthlyStats.map(item => item.count));
                            let option = {
                                title: {
                                    text: /*[[#{data_yearly_posts_distribution}]]*/ ""
                                },
                                legend: {
                                    type: 'scroll',
                                    left: '5%',
                                },
                                tooltip: {
                                    show: true,
                                    trigger: 'axis',
                                },
                                toolbox: {
                                    feature: {
                                        restore: {
                                            iconStyle: {
                                                borderColor: '#4CAF50',
                                            },
                                            emphasis: {
                                                iconStyle: {
                                                    borderColor: '#4CAF50',
                                                },
                                            },
                                        },
                                    },
                                },
                                grid: {
                                    show: false,
                                    left: '5%',
                                    bottom: '15%',
                                    containLabel: true,
                                },
                                xAxis: {
                                    type: 'category',
                                    data: monthNames,
                                    axisLabel: {
                                        margin: 15,
                                        fontSize: 12
                                    },
                                },
                                yAxis: {
                                    type: 'value',
                                    breaks: breakConfig.hasOutlier ? [breakConfig] : null,
                                    breakArea: {
                                        itemStyle: {
                                            opacity: 1
                                        },
                                        zigzagZ: 200
                                    },
                                },
                                animationDuration: 5000,
                                series: chartData.map(item => ({
                                    name: `${item.year}`,
                                    type: 'line',
                                    data: item.data,
                                    emphasis: {
                                        focus: 'series',
                                        label: {
                                            show: true,
                                        },
                                    },
                                    symbolSize: 10,
                                    endLabel: {
                                        show: true,
                                        formatter: '{a}',
                                        distance: 20,
                                    },
                                    // labelLayout: {
                                    //     moveOverlap: 'shiftY'
                                    // },
                                    lineStyle: {
                                        width: 3
                                    },
                                }))
                            };
                            trendChart.setOption(option);
                        } catch (e) {
                        }
                        window.addEventListener('resize', () => {
                            donutChart?.resize();
                            radarChart?.resize();
                            postChart?.resize();
                            trendChart?.resize();
                        })
                    }
                })
                .catch((err) => {
                    document.getElementById('donut-chart').style.display = 'none';
                    document.getElementById('radar-chart').style.display = 'none';
                    document.getElementById('post-chart').style.display = 'none';
                    document.getElementById('trend-chart').style.display = 'none';
                    console.log(err)
                })
        })
    </script>
</th:block>
