<th:block>
    <div th:if="${!#lists.isEmpty(@websiteData.postProgressStats)}" id="gauge-chart" style="height: 300px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <div th:if="${!#lists.isEmpty(topicViewBoxplotStatsList)}" id="boxplot-chart" style="height: 250px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <div th:if="${!#lists.isEmpty(topicPostMonthlyStatsList)}" id="topic-chart" style="height: 300px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <div th:if="${!#lists.isEmpty(topicPostMonthlyStatsList)}" id="topic-scatter-chart" style="height: 300px;margin-bottom: 10px;padding: 1px" class="shadow"></div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', ev => {
            const loadECharts = () => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.referrerPolicy = 'no-referrer';
                    script.crossOrigin = 'anonymous';
                    script.src = /*[[${@portal.js.get('echarts').getFirst()}]]*/ 'http://echarts.js';
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('ECharts loads on error'))
                    document.body.appendChild(script);
                });
            };
            loadECharts()
                .then(() => {
                    if (typeof echarts !== 'undefined') {
                        try {
                            const gaugeChartDom = document.getElementById('gauge-chart');
                            if (!gaugeChartDom) return;
                            var gaugeChart = echarts.init(gaugeChartDom);
                            const progressStats = /*[[${@websiteData.postProgressStats}]]*/ {};
                            if (Object.keys(progressStats).length === 0) {
                                return;
                            }
                            const now = new Date();
                            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                            const daysInYear = new Date(now.getFullYear(), 2, 0).getDate() === 29 ? 366 : 365;
                            const gaugeData = [
                                {
                                    value: (progressStats.yearCount / daysInYear),
                                    name: now.getFullYear(),
                                    title: {
                                        offsetCenter: ['0%', `-60%`],
                                    },
                                    detail: {
                                        valueAnimation: true,
                                        offsetCenter: ['0%', `-40%`],
                                        formatter: function (value) {
                                            return `${(value*daysInYear).toFixed(0)}/${daysInYear}`;
                                        }
                                    }
                                },
                                {
                                    value: progressStats.monthCount / lastDayOfMonth,
                                    name: echarts.time.format(now, '{MMM}', false),
                                    title: {
                                        offsetCenter: ['0%', `-15%`]
                                    },
                                    detail: {
                                        valueAnimation: true,
                                        offsetCenter: ['0%', `5%`],
                                        formatter: function (value) {
                                            return `${(value*lastDayOfMonth).toFixed(0)}/${lastDayOfMonth}`;
                                        }
                                    }
                                },
                                {
                                    value: progressStats.dayCount,
                                    name: now.getDate(),
                                    title: {
                                        offsetCenter: ['0%', `30%`]
                                    },
                                    detail: {
                                        valueAnimation: true,
                                        offsetCenter: ['0%', `50%`],
                                        formatter: function (value) {
                                            return `${value}/1`;
                                        }
                                    }
                                }
                            ];
                            const option = {
                                color: ['#4CAF50', '#B55EDC', '#0DB8F5',],
                                tooltip: {},
                                animationDuration: 10000,
                                series: [{
                                    type: 'gauge',
                                    radius: '90%',
                                    min: 0,
                                    max: 1,
                                    startAngle: 90,
                                    endAngle: -270,
                                    pointer: {
                                        show: false
                                    },
                                    progress: {
                                        show: true,
                                        overlap: false,
                                        roundCap: true,
                                        clip: false,
                                        itemStyle: {
                                            borderWidth: 1,
                                            borderColor: '#464646'
                                        }
                                    },
                                    axisLine: {
                                        lineStyle: {
                                            width: 20
                                        }
                                    },
                                    splitLine: {
                                        show: false,
                                        distance: 0,
                                        length: 10
                                    },
                                    axisTick: {
                                        show: false
                                    },
                                    axisLabel: {
                                        show: false,
                                        distance: 50,
                                    },
                                    data: gaugeData,
                                    title: {
                                        fontSize: 16,
                                        fontWeight: 'bolder',
                                    },
                                    detail: {
                                        height: 14,
                                        fontSize: 14,
                                        color: 'inherit',
                                        borderColor: 'inherit',
                                        borderRadius: 20,
                                        borderWidth: 1,
                                    },
                                    tooltip: {
                                        valueFormatter: (value, dataIndex) => {
                                            return `${(value*100).toFixed(0)}%`
                                        },
                                    },
                                }],
                            }
                            gaugeChart.setOption(option);
                        } catch (err) {
                            console.log(err)
                        }
                        const topicViewBoxplotStatsList = /*[[${topicViewBoxplotStatsList}]]*/ [];
                        try {
                            const boxplotChartDom = document.getElementById('boxplot-chart');
                            if (!boxplotChartDom) return;
                            var boxplotChart = echarts.init(boxplotChartDom);
                            const breaksConfig = {};
                            const xAxisData = [];
                            const boxplotData = topicViewBoxplotStatsList.sort((a, b) => b.num - a.num).map(item => {
                                xAxisData.push(item.topic);
                                if (item.max > 2 * item.whiskerMax) {
                                    breaksConfig.hasOutlier = true;
                                    breaksConfig.start = item.q3;
                                    breaksConfig.end = item.whiskerMax;
                                    breaksConfig.gap = '15%';
                                }
                                return [item.whiskerMin, item.q1, item.q2, item.q3, item.whiskerMax];
                            })
                            const option = {
                                tooltip: {},
                                color: ['#4CAF50', '#B55EDC', '#0DB8F5',],
                                grid: {
                                    show: false,
                                    left: '5%',
                                    top: '15%',
                                    bottom: '5%',
                                    containLabel: true,
                                },
                                xAxis: {
                                    name: /*[[#{v_topic}]]*/ '',
                                    nameGap: 5,
                                    type: 'category',
                                    axisTick: {
                                        show: true,
                                    },
                                    data: xAxisData,
                                },
                                yAxis: {
                                    name: /*[[#{v_view}]]*/ '',
                                    nameTextStyle: {
                                        align: 'right',
                                    },
                                    type: 'value',
                                    axisLine: {
                                        show: true,
                                    },
                                    axisTick: {
                                        show: true,
                                    },
                                    splitArea: {
                                        show: true
                                    },
                                    // breaks: breaksConfig.hasOutlier ? [{
                                    //     ...breaksConfig
                                    // }] : null,
                                    // breakArea: {
                                    //     show: true,
                                    // }
                                },
                                series: {
                                    type: 'boxplot',
                                    colorBy: 'data',
                                    data: boxplotData,
                                }
                            };
                            boxplotChart.setOption(option);
                        } catch (e) {
                        }
                        const monthlyStats = /*[[${topicPostMonthlyStatsList}]]*/ [];
                        const topicGroup = {};
                        const topicScatterGroup = {};
                        let dataMax = 0;
                        monthlyStats.forEach(item => {
                            const {topic, year, month, monthCount, cumulativeCount} = item;
                            dataMax = Math.max(dataMax, monthCount);
                            if (!topicGroup[topic]) {
                                topicGroup[topic] = [];
                            }
                            topicGroup[topic].push([
                                `${year}-${month}`,
                                cumulativeCount
                            ])
                            if (!topicScatterGroup[topic]) {
                                topicScatterGroup[topic] = [];
                            }
                            topicScatterGroup[topic].push([
                                `${year}-${month}`,
                                monthCount
                            ])
                        });
                        try {
                            const topicChartDom = document.getElementById('topic-chart');
                            if (!topicChartDom) return;
                            var topicChart = echarts.init(topicChartDom);
                            const option = {
                                title: {
                                    text: /*[[#{v_topic_trend}]]*/ "",
                                    left: 20,
                                },
                                color: ['#4CAF50', '#B55EDC', '#0DB8F5',],
                                dataZoom: [
                                    {
                                        type: 'inside'
                                    },
                                ],
                                legend: {
                                    type: 'scroll',
                                    left: 'center',
                                },
                                tooltip: {
                                    trigger: 'axis',
                                    formatter: (params) => {
                                        const param = params[0];
                                        return `${echarts.time.format(param.data[0],  '{yyyy}-{MM}', false)}<br>${param.marker}${param.seriesName}: ${param.data[1]}`;
                                    },
                                    axisPointer: {
                                        type: 'cross',
                                        label: {
                                            formatter: (params) => {
                                                if (params.axisDimension === 'x') {
                                                    return echarts.time.format(params.value,  '{yyyy}-{MM}', false)
                                                } else {
                                                    return params.value.toFixed(2);
                                                }
                                            }
                                        },
                                    },
                                },
                                grid: {
                                    show: false,
                                    left: '5%',
                                    right: '80',
                                    bottom: '15%',
                                    containLabel: true,
                                },
                                xAxis: {
                                    type: 'time',
                                    axisLabel: {
                                        formatter : '{yyyy}',
                                        hideOverlap: true,
                                    },
                                    splitLine: {
                                        show: true,
                                    },
                                    tooltip: {
                                        show: true,
                                        position: 'top',
                                    }
                                },
                                yAxis: {
                                    type: 'value',
                                    axisLine: {
                                        show: true,
                                    },
                                    axisTick: {
                                        show: true,
                                    },
                                },
                                animationDuration: 3000,
                                series: Object.entries(topicGroup).sort((a, b) => {
                                    const arrA = a[1];
                                    const arrB = b[1];
                                    return arrB[arrB.length - 1][1] - arrA[arrA.length - 1][1]
                                }).map(([topic, seriesData]) => ({
                                    name: topic,
                                    type: 'line',
                                    data: seriesData,
                                    emphasis: {
                                        focus: 'series',
                                        label: {
                                            show: true,
                                        },
                                    },
                                    smooth: true,
                                    symbol: seriesData.length > 1 ? 'none' : 'emptyCircle',
                                    endLabel: {
                                        show: true,
                                        color: 'inherit',
                                        formatter: '{a}',
                                        width: 75,
                                        distance: 5,
                                        overflow: 'breakAll',
                                    },
                                    labelLayout: {
                                        moveOverlap: 'shiftY',
                                    }
                                }))
                            };
                            topicChart.setOption(option);
                        } catch (e) {
                        }
                        try {
                            const topicScatterChartDom = document.getElementById('topic-scatter-chart');
                            if (!topicScatterChartDom) return;
                            var topicScatterChart = echarts.init(topicScatterChartDom);
                            const topicAmount = /*[[#{v_topic_scatter_amount}]]*/ "";
                            const option = {
                                title: {
                                    text: /*[[#{v_topic_scatter}]]*/ "",
                                    left: 20,
                                },
                                color: ['#4CAF50', '#B55EDC', '#0DB8F5',],
                                dataZoom: [
                                    {
                                        type: 'inside'
                                    },
                                    {
                                        type: 'slider',
                                        left: 100,
                                        right: 150,
                                        bottom: 15,
                                        height: 20,
                                        handleLabel: {
                                            show: true,
                                        },
                                        labelFormatter: function (params) {
                                            if (params) {
                                                return echarts.time.format(params,  '{yyyy}-{MM}', false)
                                            }
                                        },
                                        textStyle: {
                                            fontSize: 10
                                        }
                                    },
                                ],
                                legend: {
                                    type: 'scroll',
                                    right: 20,
                                    top: 20,
                                    width: 200,
                                    itemWidth: 10,
                                },
                                tooltip: {
                                    formatter: (params) => {
                                        return `${echarts.time.format(params.data[0],  '{yyyy}-{MM}', false)}<br>${params.marker}${params.seriesName}: ${params.data[1]}`;
                                    },
                                },
                                grid: {
                                    left: '5%',
                                    right: '110',
                                    bottom: '15%',
                                    containLabel: true,
                                },
                                xAxis: {
                                    type: 'time',
                                    axisLabel: {
                                        formatter : '{yyyy}-{MM}',
                                        hideOverlap: true,
                                    },
                                    splitLine: {
                                        show: true,
                                    },
                                    tooltip: {
                                        show: true,
                                        position: 'top',
                                    }
                                },
                                yAxis: {
                                    type: 'value',
                                    axisLine: {
                                        show: true,
                                    },
                                    axisTick: {
                                        show: true,
                                    },
                                },
                                animationDuration: 3000,
                                visualMap: [
                                    {
                                        type: 'continuous',
                                        right: 10,
                                        top: 'middle',
                                        dimension: 1,
                                        min: 0,
                                        max: dataMax,
                                        itemWidth: 20,
                                        itemHeight: 100,
                                        align: 'right',
                                        calculable: true,
                                        text: [topicAmount],
                                        textGap: 10,
                                        inRange: {
                                            symbolSize: [10, 30]
                                        },
                                        outOfRange: {
                                            symbolSize: [10, 30],
                                            color: ['#999']
                                        },
                                        controller: {
                                            inRange: {
                                                color: ['#4CAF50']
                                            },
                                            outOfRange: {
                                                color: ['#999']
                                            }
                                        }
                                    },
                                ],
                                series: Object.entries(topicScatterGroup).sort((a, b) => {
                                    return b[1].map(arr => arr[1]).reduce((acc, cur) => acc + cur, 0)
                                        - a[1].map(arr => arr[1]).reduce((acc, cur) => acc + cur, 0)
                                }).map(([topic, seriesData]) => ({
                                    name: topic,
                                    type: 'effectScatter',
                                    data: seriesData,
                                    showEffectOn: 'emphasis',
                                }))
                            };
                            topicScatterChart.setOption(option);
                        } catch (e) {
                        }
                        window.addEventListener('resize', () => {
                            gaugeChart?.resize();
                            boxplotChart?.resize();
                            topicChart?.resize();
                            topicScatterChart?.resize();
                        })
                    }
                })
                .catch((err) => {
                    document.getElementById('gauge-chart').style.display = 'none';
                    document.getElementById('boxplot-chart').style.display = 'none';
                    document.getElementById('topic-chart').style.display = 'none';
                    document.getElementById('topic-scatter-chart').style.display = 'none';
                    console.log(err)
                })
        })
    </script>
</th:block>
